const cv=document.getElementById("gameCanvas"),c=cv.getContext("2d"),tS=52,spacing=4,startX=60,startY=8,items=["FOOD","MOUSE","BOX","BALL"],itemD={FOOD:"- FOOD:\n - The cat will follow the food if it is in a straight line and there are no walls in between.",MOUSE:"- MOUSE:\n - The mouse will always try to go to the furthest tile from the cat.\n - The cat will follow it once it sees it, if it is in a straight line with no walls in between.\n - There can only be ONE mouse at a time.",BOX:"- BOX:\n - The box has the same behavior as a wall\n - It can be used to redirect the mouse and cat.",BALL:"- BALL:\n - If a ball is two tiles away from the cat, it will jump to it; ignoring walls."},levels=[{grid:["IIIIIIIIIIIIIII","IIIIIIIIIIIIIII","MMMMMMMMMMMMMMM","MIIIIIIIIIIII.F","MMMMMMMMMMMMMMM","IIIIIIIIIIIIIII","IIIIIIIIIIIIIII"],catStart:{row:3,col:1},objects:[],itemCounts:{FOOD:1,MOUSE:0,BOX:0,BALL:0},messages:["- Goal: Bring the cat to the flag.\n- Start the game by pressing the 'GO!' button.","- You can lure the cat to the flag by placing items.","- The items are at the bottom of the screen.\n- You can place them by clicking once on the item, and then on a light green tile.","- The cat will see the food if it is in a straight line and there are no walls in between."],story:["They hunt the black cat, believing it’s a witch’s manifestation. Guide it to the flag before they capture it."],stThre:{gold:5,silver:10,bronze:15}},{grid:["MMMMMMMMMMMMMMM","MIMIIIIIFIMIIIM","MIMIMMMMMMMIIIM","M.MIMIIIIIIIIIM","M.MIMIIIIIIIIIM","M.IIMIIIIIIIIIM","MMMMMMMMMMMMMMM"],catStart:{row:1,col:1},objects:[],itemCounts:{FOOD:0,MOUSE:1,BOX:0,BALL:0},messages:["- The mouse will try to evade the cat. \n- Once the cat sees the mouse, it will chase it."],story:["You helped the cat escape once, but now they’re more cautious. Use the mouse to outmaneuver them and reach the flag again."],stThre:{gold:8,silver:12,bronze:16}},{grid:["M.....MMMMMMMMM","M.MMMMMMM....MM","M.......MM.MMMM","MMMMMM.MMM.MMMM","M.............M","MMMMMMMMMM.MMFM","MMMMMMMM...MMMM"],catStart:{row:4,col:1},objects:[],itemCounts:{FOOD:0,MOUSE:1,BOX:3,BALL:0},messages:["- Place boxes to redirect the mouse.\n- The mouse will always try to go to the furthest tile from the cat."],story:["They’ve learnt that the mouse tries to go to the furthest point from the cat, and modified the path. Redirect the mouse and lead the cat to the flag."],stThre:{gold:8,silver:12,bronze:18}},{grid:["MMMMMMMMMMMMMMM","M.M...........M","MMMMMMMMMMMMMMM","MM.IIIIIIIIII.M","MMMMMMMMMMMMMMM","MM.FMMMMMMMMMMM","MMMMMMMMMMMMMMM"],catStart:{row:1,col:1},objects:[],itemCounts:{FOOD:2,MOUSE:0,BOX:0,BALL:3},messages:["If a ball is two tiles away from the cat, it will jump to it."],story:["They now decided to corner the cat with walls, but thankfully, it can jump over those thanks to the balls."],stThre:{gold:15,silver:20,bronze:30}},{grid:["MMMMMMMMMMMMMMM","M.MI........MMM","M.MIMM.MMMMMMMM","M.MIMM.MMM.MMMM","M.MMMM.MMM.M.MM","M.M....MMMMM.MM","MMMMMMMMF.II.MM"],catStart:{row:1,col:1},objects:[],itemCounts:{FOOD:3,MOUSE:1,BOX:1,BALL:4},messages:["The cat has an order of priority: The destination; then the balls, the mouse and lastly the food."],story:["After guiding safely the cat many times, they decided to make the escape even more difficult, but the hunt is not over."],stThre:{gold:18,silver:22,bronze:26}},{grid:["...............","..MMMMMMMMMMMMM","..MMMMMMMMMMMMM","IMM..........M.","I.MMM.......MM.","I.M.MM......MM.","I...MM......MMF"],catStart:{row:0,col:0},objects:[],itemCounts:{FOOD:0,MOUSE:2,BOX:9,BALL:3},messages:["There can only be a mouse at a time."],story:["They try to confuse you with complex paths, but you have already saved the black cat many times."],stThre:{gold:15,silver:20,bronze:25}},{grid:["FMMMMMMMMMMMMM.",".M.M.M...M.M.M.","IMMMMM..IMMMMM.","IMI.IM..IMI.IM.","IM..IM..IM..IM.","IM.MIM..IM.MIM.","IM.MIM..IM.MIM."],catStart:{row:4,col:14},objects:[{row:2,col:14,type:"MOUSE"},{row:1,col:12,type:"BALL"},{row:1,col:10,type:"BALL"},{row:3,col:10,type:"BALL"},{row:5,col:10,type:"BALL"},{row:1,col:4,type:"BALL"},{row:1,col:2,type:"BALL"},{row:3,col:2,type:"BALL"},{row:5,col:2,type:"BALL"}],itemCounts:{FOOD:4,MOUSE:3,BOX:1,BALL:8},messages:["The cat prefers certain balls to others.\n The order of preference is bottom, top, right, and left."],story:["The hunt is arriving to an end soon, but the cat is stuck in some sort of maze; help it once again."],stThre:{gold:35,silver:40,bronze:45}},{grid:["..IM.......MI..",".IM.MIMMMIM.MI.","IMIMIM...M.M.MI","MIM.MIMIM.M.M.M","IM.M.M..IM.MIMI",".IMIMIMMMM.IMM.","F.IMI.IMI.I.I.."],catStart:{row:3,col:11},objects:[{row:3,col:13,type:"BALL"},{row:3,col:11,type:"BALL"},{row:3,col:9,type:"BALL"},{row:3,col:7,type:"BALL"},{row:1,col:11,type:"BALL"},{row:5,col:11,type:"BALL"},{row:2,col:10,type:"BALL"},{row:4,col:12,type:"BALL"},{row:2,col:12,type:"BALL"},{row:4,col:10,type:"BALL"},{row:3,col:5,type:"BALL"},{row:3,col:1,type:"BALL"},{row:1,col:3,type:"BALL"},{row:5,col:3,type:"BALL"},{row:2,col:2,type:"BALL"},{row:4,col:4,type:"BALL"},{row:2,col:4,type:"BALL"},{row:4,col:2,type:"BALL"},{row:1,col:1,type:"BALL"},{row:2,col:6,type:"BALL"},{row:4,col:8,type:"BALL"},{row:4,col:6,type:"FOOD"},{row:4,col:0,type:"BALL"},{row:2,col:14,type:"BALL"},{row:4,col:14,type:"BALL"},{row:0,col:1,type:"MOUSE"}],itemCounts:{FOOD:2,MOUSE:1,BOX:2,BALL:8},messages:["The cat is stuck between many balls; but its priorities didn't change."],story:["You're almost there, but they decided to confuse you by placing many items too; show them who places item the best."],stThre:{gold:42,silver:46,bronze:50}},{grid:["...I..III......","..II.II.II.....",".I..MM...MM....","M.F.I.....II.IM",".M..MM...MM.II.",".M.MMII.II.II..",".I....III..M..."],catStart:{row:0,col:0},objects:[],teleporters:[{row:3,col:5,destination:{row:5,col:13}},{row:3,col:9,destination:{row:6,col:0}},{row:5,col:7,destination:{row:0,col:0}},{row:1,col:7,destination:{row:6,col:14}},{row:3,col:1,destination:{row:3,col:14}},{row:3,col:3,destination:{row:3,col:1}},{row:4,col:2,destination:{row:6,col:14}},{row:2,col:2,destination:{row:6,col:14}},{row:0,col:2,destination:{row:0,col:14}},{row:0,col:12,destination:{row:3,col:7}},{row:0,col:10,destination:{row:0,col:14}},{row:2,col:0,destination:{row:5,col:2}},{row:2,col:14,destination:{row:4,col:11}},{row:4,col:0,destination:{row:6,col:14}},{row:4,col:14,destination:{row:6,col:14}},{row:6,col:2,destination:{row:4,col:11}},{row:6,col:12,destination:{row:6,col:14}}],itemCounts:{FOOD:3,MOUSE:0,BOX:0,BALL:2},messages:["Use the teleporters to reach the flag!"],story:["This is the final escape; they laid many teleporters to corner the cat; but through trial and error you will be able to save the cat for good."],stThre:{gold:10,silver:14,bronze:20}}];class Particle{constructor(e,t,l,o,i,r,a){this.x=e,this.y=t,this.color=l,this.size=o,this.speedX=Math.cos(r)*i,this.speedY=Math.sin(r)*i,this.lifetime=a,this.maxLifetime=a}update(){return this.x+=this.speedX,this.y+=this.speedY,this.lifetime--,this.lifetime>0}draw(e){let t=this.lifetime/this.maxLifetime;e.fillStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${t})`,e.beginPath(),e.arc(this.x,this.y,this.size*(this.lifetime/this.maxLifetime),0,2*Math.PI),e.fill()}}class ParticleSystem{constructor(){this.particles=[]}addParticle(e,t,l,o,i,r,a){this.particles.push(new Particle(e,t,l,o,i,r,a))}addX(e,t,l,o,i,r,a){for(let n=0;n<l;n++){let s=Math.random()*Math.PI*2;this.addParticle(e,t,o,i,r,s,a)}}update(){this.particles=this.particles.filter(e=>e.update())}draw(e){this.particles.forEach(t=>t.draw(e))}}const particleSystem=new ParticleSystem;let tbce_currentLevel=0,ac=new(window.AudioContext||window.webkitAudioContext),inLevelMenu=!1,tbce_maxLevel=parseInt(localStorage.getItem("tbce_maxLevel"))||0,showStartMenu=tbce_maxLevel>0&&0!==tbce_currentLevel&&tbce_currentLevel<levels.length-1,unlockedLevels=Array.from({length:tbce_maxLevel+1},(e,t)=>t),cW=0,mouseMoveWait=0,gameSpeed=1;const MIN_SPEED=.25,MAX_SPEED=2,SPEED_STEP=.25;let MOVE_DELAY=30,selectedItem=null,placedObjects=[],grid=[],objects=[],cat={},chasing=!1,mouse=null,itemCounts={},menuState="start",selectedHowToPlayCategory="Tiles",tutorialActive=!1,tutorialMessages=[],infoActive=!1,infoMessage="",curridx=0,gameStarted=!1,lmd={dr:0,dc:0},teleporters=[],lastTeleporterUsed=null,musicPlaying=!1,soundOn=!0,noteIndex=0,melodyTimeout,levelStartTime=0,tbce_levelTimes=JSON.parse(localStorage.getItem("tbce_levelTimes"))||Array(levels.length).fill(1/0),tbce_levelStars=JSON.parse(localStorage.getItem("tbce_levelStars"))||Array(levels.length).fill(0),storyActive=!1,storyMessages=[],csidx=0;const melodyFreqs=[220,247,262,294,330,392,220,247,262,294,330,392,220,247,262,294,330,392,262,294,330,262,294,330,440,110,220,110,247,110,262,110,294,110,330,110,392,110,220,110,247,110,262,110,294,110,330,110,392,110,262,110,294,110,330,110,262,110,294,110,330,110,440,220,247,255,294,311,392,220,247,262,294,330,392,220,247,262,287,330,392,262,294,311,262,294,330,440,110,0,220,0,110,0,247,0,110,0,262,0,110,0,294,0,110,0,330,0,110,0,392,0,110,0,0,0,440,0,0,0],melodyDurations=[.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,1,.33,.33,.34,.33,.33,.34,2,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,1,.3,.5,.3,.5,.3,.5,.3,.5,.3,.5,.3,1,.3,.33,.3,.33,.3,.34,.3,.33,.3,.33,.3,.34,.3,2,.5,.5,.5,.5,.5,1,.5,.5,1,.5,.5,1,.5,.5,.5,.5,.5,1,.33,.33,.34,.33,.33,.34,2,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,1.5,.5,2,.5,.5,.5,2,.5,1,1],musicGain=ac.createGain(),sfxGain=ac.createGain();function unlockAudio(){"suspended"===ac.state&&ac.resume(),musicPlaying||"running"!==ac.state||(startMusic(),["click","keydown","touchstart"].forEach(e=>{window.removeEventListener(e,unlockAudio)}))}function loadLevel(e){let t=levels[e];if(grid=t.grid.map(e=>e.split("")),cat={...t.catStart},itemCounts={...t.itemCounts},objects=Array.from({length:grid.length},()=>Array(grid[0].length).fill(null)),teleporters=t.teleporters||[],chasing=!1,selectedItem=null,t.messages&&t.messages.length>0?(tutorialMessages=t.messages,curridx=0,tutorialActive=!0,gameStarted=!1):(tutorialActive=!1,gameStarted=!1),t.story&&t.story.length>0?(storyMessages=t.story,csidx=0,storyActive=!1):(storyMessages=[],csidx=0,storyActive=!1),t.objects)for(let l of t.objects)objects[l.row][l.col]="FOOD"===l.type?"D":"MOUSE"===l.type?"O":"BOX"===l.type?"X":"B";mouse=null;for(let o=0;o<grid.length;o++)for(let i=0;i<grid[0].length;i++)if("O"===objects[o][i]){mouse={row:o,col:i};break}levelStartTime=Date.now()}function wrapText(e,t,l,o,i,r){let a=t.split("\n"),n=o;for(let s of a){let $=s.split(" "),M="";for(let f=0;f<$.length;f++){let u=M+$[f]+" ";e.measureText(u).width>i&&f>0?(e.fillText(M.trim(),l,n),M=$[f]+" ",n+=r):M=u}e.fillText(M.trim(),l,n),n+=r}}function drawStartMenu(){c.fillStyle="rgba(0, 0, 0, 0.8)",c.fillRect(0,0,cv.width,cv.height),c.fillStyle="white",c.font="36px sans-serif",c.textAlign="center",c.fillText("Welcome to the Game!",cv.width/2,cv.height/2-50),c.fillStyle="#4CAF50",c.fillRect(cv.width/2-100,cv.height/2,200,50),c.fillStyle="white",c.font="24px sans-serif",c.fillText("Start Game",cv.width/2,cv.height/2+30),c.fillStyle="#2196F3",c.fillRect(cv.width/2-100,cv.height/2+70,200,50),c.fillStyle="white",c.fillText("How to Play",cv.width/2,cv.height/2+100)}function drawHowToPlayModal(){c.fillStyle="rgba(0, 0, 0, 0.9)",c.fillRect(0,0,cv.width,cv.height),c.fillStyle="white",c.font="32px sans-serif",c.textAlign="center",c.fillText("How to Play",cv.width/2,100);let e=cv.width/2-300;c.fillStyle="Tiles"===selectedHowToPlayCategory?"#007BFF":"#2196F3",c.fillRect(e,150,180,40),c.fillStyle="white",c.font="20px sans-serif",c.textAlign="center",c.fillText("Tiles",e+90,175),c.fillStyle="Items"===selectedHowToPlayCategory?"#007BFF":"#2196F3",c.fillRect(e+180+30,150,180,40),c.fillStyle="white",c.fillText("Items",e+180+30+90,175),c.fillStyle="Game Buttons"===selectedHowToPlayCategory?"#007BFF":"#2196F3",c.fillRect(e+420,150,180,40),c.fillStyle="white",c.fillText("Game Buttons",e+420+90,175),c.fillStyle="#f44336",c.fillRect(cv.width/2-50,cv.height-100,100,40),c.fillStyle="white",c.font="20px sans-serif",c.textAlign="center",c.fillText("Close",cv.width/2,cv.height-70),c.font="20px sans-serif",c.textAlign="left","Tiles"===selectedHowToPlayCategory?(c.fillText("Tiles:",100,220),c.fillText("- The cat can pass through light green tiles, and you can place items on those tiles.",120,250),c.fillText("- The cat cannot pass through dark green tiles, but you can place items on those tiles.",120,280),c.fillText("- Walls: The cat cannot pass through black tiles, and you cannot place items on those tiles.",120,310),c.fillText("- The flag is the goal. Bring the cat there to win!",120,340)):"Items"===selectedHowToPlayCategory?(c.fillText("Items:",100,220),c.fillText("- FOOD: The cat will follow the food if it is in a straight line with no walls.",120,250),c.fillText("- MOUSE: The mouse evades the cat. The cat will chase it if it sees it.",120,280),c.fillText("- BOX: Acts like a wall. Use it to redirect the mouse or cat.",120,310),c.fillText("- BALL: If a ball is two tiles away, the cat will jump to it, ignoring walls and boxes.",120,340)):"Game Buttons"===selectedHowToPlayCategory&&(c.fillText("Game Buttons:",100,220),c.fillText("- GO!: Start the game.",120,250),c.fillText("- Reset (↻): Reset the current level.",120,280),c.fillText("- Cancel (✕): Remove the last placed item.",120,310),c.fillText("- Sound: Toggle sound on/off.",120,340),c.fillText("- Speed: Adjust the game speed with the plus and minus buttons.",120,370))}function drawTutorialMessage(){tutorialActive&&(c.fillStyle="rgba(0,0,0,0.7)",c.fillRect(50,100,800,200),c.fillStyle="white",c.font="18px sans-serif",c.textAlign="left",c.textBaseline="top",c.fillText(`Message ${curridx+1}/${tutorialMessages.length}`,70,105),c.font="20px sans-serif",wrapText(c,tutorialMessages[curridx],70,135,760,28),c.fillStyle="yellow",c.font="18px sans-serif",c.textAlign="right",c.fillText("Click to continue...",830,270))}function drawStoryMessage(){storyActive&&(c.fillStyle="rgba(30, 30, 80, 0.85)",c.fillRect(50,100,800,200),c.fillStyle="white",c.font="18px sans-serif",c.textAlign="left",c.textBaseline="top",c.fillText(`Story ${csidx+1}/${storyMessages.length}`,70,105),c.font="20px sans-serif",wrapText(c,storyMessages[csidx],70,135,760,28),c.fillStyle="yellow",c.font="18px sans-serif",c.textAlign="right",c.fillText("Click to continue...",830,270))}function drawCat(e,t){let l=60+56*t,o=8+56*e,i=l+26,r=o+26;c.fillStyle="black",c.beginPath(),c.fillRect(l+10,o+10,32,32),c.fill(),c.beginPath(),c.moveTo(l+10,o+10),c.lineTo(l+15,o+2),c.lineTo(l+20,o+10),c.closePath(),c.fill(),c.beginPath(),c.moveTo(l+32,o+10),c.lineTo(l+37,o+2),c.lineTo(l+42,o+10),c.closePath(),c.fill(),c.beginPath(),lmd.dc<0?(c.fillRect(l+52-10,r+8,8,4),c.fillRect(l+52-6,r+8,4,-20)):(lmd.dc,c.fillRect(l+2,r+8,8,4),c.fillRect(l+2,r+8,4,-20)),c.fill(),c.fillStyle="white",c.beginPath(),c.fillRect(i-10,r-7,4,10),c.fillRect(i+6,r-7,4,10),c.fill(),c.fillStyle="pink",c.beginPath(),c.fillRect(i-6,r+8,12,4),c.fill()}function drawMouse(){if(!mouse)return;let e=60+56*mouse.col,t=8+56*mouse.row;drawItem("O",e,t,52)}function drawItem(e,t,l,o){if("D"===e)c.strokeStyle="black",c.lineWidth=2,c.fillStyle="#1a8bbc",c.beginPath(),c.moveTo(t+o/2+15,l+o/2+6),c.lineTo(t+o/2,l+o/2-2),c.lineTo(t+o/2+15,l+o/2-6),c.closePath(),c.fill(),c.stroke(),c.ellipse(t+o/2-4,l+o/2,o/4,o/5,0,0,2*Math.PI),c.stroke(),c.beginPath(),c.lineTo(t+o/2+15,l+o/2-6),c.closePath(),c.stroke(),c.beginPath(),c.moveTo(t+o/2-4,l+17),c.lineTo(t+o/2,l+10),c.lineTo(t+o/2+2,l+17),c.closePath(),c.stroke(),c.beginPath(),c.ellipse(t+o/2-4,l+o/2,o/4,o/5,0,0,2*Math.PI),c.fill(),c.beginPath(),c.moveTo(t+o/2-4,l+17),c.lineTo(t+o/2,l+10),c.lineTo(t+o/2+2,l+17),c.closePath(),c.fill(),c.fillStyle="black",c.beginPath(),c.arc(t+o/2-10,l+o/2-2,1.5,0,2*Math.PI),c.fill(),c.lineWidth=1,c.beginPath(),c.arc(t+o/2-12,l+o/2+3,1.5,0,Math.PI,!0),c.stroke();else if("O"===e){let i=t+o/2,r=l+o/2;c.strokeStyle="black",c.beginPath(),c.arc(i,r,14,0,2*Math.PI),c.stroke(),c.beginPath(),c.arc(i-10,r-10,6,0,2*Math.PI),c.arc(i+10,r-10,6,0,2*Math.PI),c.stroke(),c.fillStyle="rgba(220,220,220,1)",c.beginPath(),c.arc(i,r,14,0,2*Math.PI),c.fill(),c.beginPath(),c.arc(i-10,r-10,6,0,2*Math.PI),c.arc(i+10,r-10,6,0,2*Math.PI),c.fill(),c.fillStyle="black",c.beginPath(),c.arc(i-5,r-3,2,0,2*Math.PI),c.arc(i+5,r-3,2,0,2*Math.PI),c.fill(),c.strokeStyle="black",c.lineWidth=1,c.beginPath(),c.moveTo(i-4,r+2),c.lineTo(i-12,r+6),c.moveTo(i-4,r+4),c.lineTo(i-12,r+10),c.moveTo(i+4,r+2),c.lineTo(i+12,r+6),c.moveTo(i+4,r+4),c.lineTo(i+12,r+10),c.stroke()}else"B"===e?(c.fillStyle="#cc050c",c.beginPath(),c.arc(t+o/2,l+o/2,14,0,2*Math.PI),c.fill(),c.strokeStyle="#cc050c",c.stroke()):"X"===e&&(c.fillStyle="#cfa854",c.fillRect(t+4,l+4,o-8,o-8),c.strokeStyle="black",c.strokeRect(t+4,l+4,o-8,o-8),c.beginPath(),c.moveTo(t+4,l+o/2),c.lineTo(t+o-4,l+o/2),c.moveTo(t+o/2,l+4),c.lineTo(t+o/2,l+o-4),c.strokeStyle="#654321",c.stroke())}function drawTeleporters(){for(let e of teleporters){let t=60+56*e.col,l=8+56*e.row,o=t+26,i=l+26,r=52/3,a=c.createRadialGradient(o,i,.2*r,o,i,r);a.addColorStop(0,"rgba(200, 100, 255, 0.8)"),a.addColorStop(1,"rgba(100, 0, 150, 0.9)"),c.fillStyle=a,c.beginPath(),c.arc(o,i,r,0,2*Math.PI),c.fill(),c.strokeStyle="white",c.lineWidth=2,c.beginPath();for(let n=0;n<4*Math.PI;n+=.2){let s=r*n/(4*Math.PI),$=o+Math.cos(n)*s,M=i+Math.sin(n)*s;0===n?c.moveTo($,M):c.lineTo($,M)}c.stroke()}}function drawGrid(e,t){c.lineWidth=2;for(let l=0;l<e;l++)for(let o=0;o<t;o++){let i=grid[l][o],r=60+56*o,a=8+56*l;if(c.fillStyle="#92c487",c.fillRect(r,a,52,52),c.strokeStyle="#fff",c.strokeRect(r,a,52,52),"I"===i&&(c.fillStyle="#5b8452",c.fillRect(r,a,52,52),c.strokeStyle="#fff",c.strokeRect(r,a,52,52)),"M"===i){c.fillStyle="black",c.strokeStyle="black";let n=o>0&&"M"===grid[l][o-1],s=o<t-1&&"M"===grid[l][o+1],$=l>0&&"M"===grid[l-1][o],M=l<e-1&&"M"===grid[l+1][o],f=$&&n&&"M"===grid[l-1][o-1],u=$&&s&&"M"===grid[l-1][o+1],d=M&&n&&"M"===grid[l+1][o-1],_=M&&s&&"M"===grid[l+1][o+1],h=r,m=a,g=52,w=52;n&&(h-=2,g+=2),s&&(g+=2),$&&(m-=2,w+=2),M&&(w+=2),c.fillRect(h,m,g,w),!f&&$&&n&&(c.fillStyle="#D3D3D3",c.fillRect(r-4,a-4,4,4)),!u&&$&&s&&(c.fillStyle="#D3D3D3",c.fillRect(r+52,a-4,4,4)),!d&&M&&n&&(c.fillStyle="#D3D3D3",c.fillRect(r-4,a+52,4,4)),!_&&M&&s&&(c.fillStyle="#D3D3D3",c.fillRect(r+52,a+52,4,4))}else if("F"===i){c.fillStyle="#5b8452",c.fillRect(r,a,52,52),c.fillStyle="black",c.fillRect(r+7,a+10,3,40),c.fillStyle="red";for(let y=0;y<8;y++)for(let I=0;I<5;I++)(y+I)%2==0?c.fillStyle="white":c.fillStyle="black",c.fillRect(r+10+4*y,a+10+4*I,4,4)}objects[l][o]&&drawItem(objects[l][o],r,a,52)}}function drawSlots(){for(let e=0;e<items.length;e++){let t=items[e],l=20+190*e;c.beginPath(),c.fillStyle=selectedItem===t?"#AAAAAA":"#C3C3C3",c.roundRect(l,420,180,100,10),c.fill(),c.fillStyle="#000",c.font="20px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText(t,l+90,450),c.fillStyle="red",c.beginPath(),c.arc(l+180-30,450,20,0,2*Math.PI),c.fill(),c.fillStyle="white",c.font="16px sans-serif",c.fillText(itemCounts[t],l+180-30,450);drawItem("FOOD"===t?"D":"MOUSE"===t?"O":"BOX"===t?"X":"B",l+70,470,40),c.fillStyle="#3A8DFF",c.beginPath(),c.arc(l+20,450,15,0,2*Math.PI),c.fill(),c.fillStyle="white",c.font="16px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("i",l+20,450)}}function drawInfoMessage(){infoActive&&(c.fillStyle="rgba(0,0,0,0.7)",c.fillRect(100,120,700,180),c.fillStyle="white",c.font="20px sans-serif",c.textAlign="left",c.textBaseline="top",wrapText(c,infoMessage,120,140,660,26),c.fillStyle="yellow",c.font="18px sans-serif",c.textAlign="right",c.fillText("Click to close...",780,270))}function showLevelMenu(){inLevelMenu=!0,c.fillStyle="rgba(0,0,0,0.8)",c.fillRect(110,50,735,300),c.fillStyle="white",c.font="24px sans-serif",c.textAlign="center",c.fillText("Level finished!",480,90),c.fillStyle="#4CAF50",c.fillRect(320,130,150,50),c.fillStyle="white",c.fillText("Play again",395,155),tbce_currentLevel+1<levels.length&&(c.fillStyle="#2196F3",c.fillRect(490,130,150,50),c.fillStyle="white",c.fillText("Next level",565,155)),c.font="18px sans-serif",c.textAlign="left";for(let e=0;e<levels.length;e++)c.fillStyle=unlockedLevels.includes(e)?"#4CAF50":"#757575",c.fillRect(220+60*e,270,40,40),c.fillStyle="white",c.fillText(e+1,235+60*e,295);for(let t=0;t<tbce_levelStars[tbce_currentLevel];t++)c.fillStyle="gold",c.save(),c.translate(440+40*t,225),drawStar(c,0,0,20),c.restore();for(let l=0;l<levels.length;l++)if(unlockedLevels.includes(l))for(let o=0;o<tbce_levelStars[l];o++)c.fillStyle="gold",c.save(),c.translate(230+60*l+10*o,280),drawStar(c,0,0,5),c.restore()}function drawGoButton(){let e=20+190*items.length;c.fillStyle="#AAAAAA",c.fillRect(e,430,40,40),c.fillStyle="white",c.font="20px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("GO!",e+20,450)}function drawResetButton(){let e=20+190*items.length+40+10;c.fillStyle="#AAAAAA",c.fillRect(e,430,40,40),c.fillStyle="white",c.font="24px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("↻",e+20,450)}function drawCancelButton(){let e=20+190*items.length+40+10+50;c.fillStyle="#AAAAAA",c.fillRect(e,430,40,40),c.fillStyle="white",c.font="20px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("✕",e+20,450)}function drawSoundButton(){let e=20+190*items.length;c.fillStyle=soundOn?"#4CAF50":"#f44336",c.fillRect(e,480,40,40),c.fillStyle="white",c.font="20px Arial",c.textAlign="center",c.fillText(soundOn?"\uD83D\uDD0A":"\uD83D\uDD07",e+20,500,30,30)}function drawSpeedMinusButton(){let e=20+190*items.length+40+10;c.fillStyle="#AAAAAA",c.fillRect(e,495,25,25),c.fillStyle="white",c.font="24px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("-",e+12.5,507.5)}function drawSpeedPlusButton(){let e=20+190*items.length+40+10+65;c.fillStyle="#AAAAAA",c.fillRect(e,495,25,25),c.fillStyle="white",c.font="24px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("+",e+12.5,507.5)}function drawSpeedText(){let e=20+190*items.length+40+10+45;c.fillStyle="white",c.font="12px sans-serif",c.textAlign="center",c.textBaseline="middle",c.fillText("Game speed: ",e,485),c.fillText(`${gameSpeed.toFixed(2)}x`,e,507)}function drawStar(e,t,l,o){e.beginPath();let i=o,r=.4*o;for(let a=0;a<10;a++){let n=a*Math.PI/5-Math.PI/2,s=a%2==0?i:r,$=t+Math.cos(n)*s,M=l+Math.sin(n)*s;0===a?e.moveTo($,M):e.lineTo($,M)}e.closePath(),e.fill()}function drawStars(e,t,l,o=8){for(let i=0;i<l;i++)c.fillStyle="gold",c.save(),c.translate(e+33*i,t),drawStar(c,0,0,o),c.restore()}function cancelLastPlacement(){if(0===placedObjects.length||gameStarted)return;let e=placedObjects.pop(),{row:t,col:l,type:o}=e;"O"===objects[t][l]&&(mouse=null),objects[t][l]=null,itemCounts[o]++}function draw(){c.clearRect(0,0,cv.width,cv.height),"start"===menuState?drawStartMenu():"howToPlay"===menuState?drawHowToPlayModal():(drawGrid(7,15),drawTeleporters(),mouse&&drawMouse(),drawCat(cat.row,cat.col),c.strokeStyle="#AAAAAA",c.beginPath(),c.moveTo(40,410),c.lineTo(920,410),c.stroke(),drawSlots(),drawGoButton(),drawResetButton(),drawCancelButton(),drawSoundButton(),drawSpeedMinusButton(),drawSpeedPlusButton(),drawSpeedText(),tutorialActive?drawTutorialMessage():storyActive&&drawStoryMessage(),infoActive&&drawInfoMessage(),inLevelMenu&&showLevelMenu(),particleSystem.update(),particleSystem.draw(c))}function calculateStars(e,t=tbce_currentLevel){let l=levels[t].stThre,o=e*gameSpeed;return o<=l.gold?3:o<=l.silver?2:o<=l.bronze?1:0}function playNote(e=440,t=.2,l="square"){if(soundOn)try{let o=ac.createOscillator(),i=ac.createGain();o.type=l,o.frequency.value=e,o.connect(i),i.connect(sfxGain),i.gain.setValueAtTime(0,ac.currentTime),i.gain.linearRampToValueAtTime(.05,ac.currentTime+.01),i.gain.linearRampToValueAtTime(.05,ac.currentTime+.01),i.gain.linearRampToValueAtTime(0,ac.currentTime+t),o.start(ac.currentTime),o.stop(ac.currentTime+t)}catch(r){console.error("Error playing note:",r)}}function playNextNote(){if(!musicPlaying||!soundOn)return;let e=melodyFreqs[noteIndex],t=melodyDurations[noteIndex],l=ac.createOscillator(),o=ac.createGain();l.type="sine",l.frequency.value=e,o.gain.setValueAtTime(0,ac.currentTime),o.gain.linearRampToValueAtTime(.1,ac.currentTime+.05),o.gain.linearRampToValueAtTime(0,ac.currentTime+t),l.connect(o),o.connect(musicGain),l.start(),l.stop(ac.currentTime+t+.1),noteIndex=(noteIndex+1)%melodyFreqs.length,melodyTimeout=setTimeout(playNextNote,1e3*t)}function startMusic(){musicPlaying||"running"!==ac.state||(musicPlaying=!0,noteIndex=0,playNextNote())}function stopMusic(){musicPlaying=!1,clearTimeout(melodyTimeout)}function sfxItem(){soundOn&&[150,350].forEach((e,t)=>{setTimeout(()=>{playNote(e,.15)},150*t)})}function sfxJump(){soundOn&&["sawtooth","triangle"].forEach((e,t)=>{let l=ac.createOscillator(),o=ac.createGain();l.type=e,l.frequency.setValueAtTime(800,ac.currentTime),l.frequency.exponentialRampToValueAtTime(300,ac.currentTime+.25),o.gain.setValueAtTime(0,ac.currentTime),o.gain.linearRampToValueAtTime(.05+.1*t,ac.currentTime+.01),o.gain.linearRampToValueAtTime(0,ac.currentTime+.25),l.connect(o),o.connect(sfxGain),l.start(ac.currentTime),l.stop(ac.currentTime+.25)})}function sfxTeleport(){if(!soundOn)return;let e=ac.createOscillator(),t=ac.createGain();e.type="triangle",e.frequency.setValueAtTime(1500,ac.currentTime),e.frequency.exponentialRampToValueAtTime(150,ac.currentTime+.4);let l=ac.createOscillator(),o=ac.createGain();l.frequency.value=25,o.gain.value=80,l.connect(o),o.connect(e.frequency),t.gain.setValueAtTime(0,ac.currentTime),t.gain.linearRampToValueAtTime(.15,ac.currentTime+.02),t.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.4),e.connect(t),t.connect(sfxGain),e.start(ac.currentTime),e.stop(ac.currentTime+.4),l.start(ac.currentTime),l.stop(ac.currentTime+.4);let i=ac.createOscillator(),r=ac.createGain();i.type="sine",i.frequency.setValueAtTime(2e3,ac.currentTime),r.gain.setValueAtTime(.3,ac.currentTime),r.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.15),i.connect(r),r.connect(sfxGain),i.start(ac.currentTime),i.stop(ac.currentTime+.15)}function sfxStep(){soundOn&&playNote(800,.1,"triangle")}function sfxWin(){soundOn&&[440,660,880].forEach((e,t)=>{setTimeout(()=>{playNote(e,.15)},150*t)})}function moveCat(){if(null===mouse&&(chasing=!1),chasing||(chasing=findVisibleMouse(cat.row,cat.col)),cW>0){cW--;return}for(let e of(lastTeleporterUsed&&(lastTeleporterUsed.row!==cat.row||lastTeleporterUsed.col!==cat.col)&&(lastTeleporterUsed=null),teleporters))if(cat.row===e.row&&cat.col===e.col&&!(cat.row===e.destination.row&&cat.col===e.destination.col)&&!(lastTeleporterUsed&&lastTeleporterUsed.row===e.row&&lastTeleporterUsed.col===e.col)){cat.row=e.destination.row,cat.col=e.destination.col;let t=60+56*cat.col+26,l=8+56*cat.row+26;particleSystem.addX(t,l,20,{r:0,g:0,b:255},3,2,40);let o=(e.col+1)*56+26,i=56*e.row+26;particleSystem.addX(o,i,20,{r:0,g:0,b:255},3,2,40),sfxTeleport(),cW=MOVE_DELAY,lastTeleporterUsed=e.destination;return}for(let[r,a]of[[0,1],[1,0],[0,-1],[-1,0]]){let n=cat.row+r,s=cat.col+a;if(n>=0&&n<7&&s>=0&&s<15&&"F"===grid[n][s]){cat.row=n,cat.col=s,sfxWin();let $=Math.floor((Date.now()-levelStartTime)/1e3),M=calculateStars($,tbce_currentLevel);M>tbce_levelStars[tbce_currentLevel]&&(tbce_levelStars[tbce_currentLevel]=M,localStorage.setItem("tbce_levelStars",JSON.stringify(tbce_levelStars))),$<tbce_levelTimes[tbce_currentLevel]&&(tbce_levelTimes[tbce_currentLevel]=$,localStorage.setItem("tbce_levelTimes",JSON.stringify(tbce_levelTimes))),gameStarted=!1,loadNextLevel();return}}for(let[f,u]of[[2,0],[-2,0],[0,2],[0,-2]]){let d=cat.row+f,_=cat.col+u;if(d>=0&&d<7&&_>=0&&_<15&&"B"===objects[d][_]){cat.row=d,cat.col=_,objects[d][_]=null,cW=Math.round(60/gameSpeed),sfxJump();return}}if(mouse&&chasing){let h=findPath(cat.row,cat.col,mouse.row,mouse.col);if(h&&h.length>0){let m=h[0];lmd={dr:m.row-cat.row,dc:m.col-cat.col},cat.row=m.row,cat.col=m.col,sfxStep(),cW=MOVE_DELAY,cat.row===mouse.row&&cat.col===mouse.col&&(objects[mouse.row][mouse.col]=null,mouse=null);return}}let g=findVisibleFood(cat.row,cat.col);if(g){let[w,y]=g;lmd={dr:w-cat.row,dc:y-cat.col},w!==cat.row?cat.row+=Math.sign(w-cat.row):y!==cat.col&&(cat.col+=Math.sign(y-cat.col)),w===cat.row&&y===cat.col&&(objects[w][y]=null),sfxStep(),cW=Math.round(Math.floor(30*Math.random()+10)/gameSpeed);return}let I=teleporters.filter(e=>Math.abs(e.row-cat.row)+Math.abs(e.col-cat.col)===1);if(I.length>0){let p=I[0];lmd={dr:p.row-cat.row,dc:p.col-cat.col},cat.row=p.row,cat.col=p.col,cW=MOVE_DELAY;return}}function moveMouse(){if(!mouse)return;if(mouseMoveWait>0){mouseMoveWait--;return}let e=[],t=new Set,l=[[mouse.row,mouse.col]],o=(e,t)=>`${e},${t}`;for(;l.length>0;){let[i,r]=l.shift();!(i<0||i>=grid.length||r<0||r>=grid[0].length||"M"===grid[i][r]||"X"===objects[i][r]||i===cat.row&&r===cat.col||t.has(o(i,r)))&&(t.add(o(i,r)),e.push([i,r]),l.push([i-1,r]),l.push([i+1,r]),l.push([i,r-1]),l.push([i,r+1]))}if(0===e.length)return;let a=e.map(([e,t])=>{let l=findPath(e,t,cat.row,cat.col);return{cell:[e,t],distance:l?l.length:1/0}});a.sort((e,t)=>t.distance-e.distance);let n=a[0].cell,s=new Set([`${cat.row},${cat.col}`]),$=findPath(mouse.row,mouse.col,n[0],n[1],s);if($&&$.length>0){"O"===objects[mouse.row][mouse.col]&&(objects[mouse.row][mouse.col]=null);let M=$[0];mouse.row=M.row,mouse.col=M.col}mouseMoveWait=MOVE_DELAY}function findVisibleFood(e,t){for(let[l,o]of[[0,1],[1,0],[0,-1],[-1,0]]){let i=e,r=t;for(;i+=l,r+=o,!(i<0)&&!(i>=7)&&!(r<0)&&!(r>=15)&&"M"!==grid[i][r]&&"X"!==objects[i][r];)if("D"===objects[i][r])return[i,r]}return null}function findVisibleMouse(e,t){for(let[l,o]of[[0,1],[1,0],[0,-1],[-1,0]]){let i=e,r=t;for(;i+=l,r+=o,!(i<0)&&!(i>=7)&&!(r<0)&&!(r>=15)&&"M"!==grid[i][r]&&"X"!==objects[i][r];)if(mouse&&i===mouse.row&&r===mouse.col)return[i,r]}return null}function findPath(e,t,l,o,i=new Set){let r=grid.length,a=grid[0].length,n=Array.from({length:r},()=>Array(a).fill(!1)),s=[],$={},M=(e,t)=>`${e},${t}`;for(s.push({row:e,col:t}),n[e][t]=!0;s.length>0;){let f=s.shift();if(f.row===l&&f.col===o){let u=[],d={row:l,col:o};for(;d.row!==e||d.col!==t;)u.unshift(d),d=$[`${d.row},${d.col}`];return u}let _=[[0,1],[1,0],[0,-1],[-1,0]];for(let[h,m]of _){let g=f.row+h,w=f.col+m;g>=0&&g<r&&w>=0&&w<a&&!n[g][w]&&"M"!==grid[g][w]&&"X"!==objects[g][w]&&!i.has(M(g,w))&&(n[g][w]=!0,$[`${g},${w}`]={row:f.row,col:f.col},s.push({row:g,col:w}))}}return null}function loadNextLevel(){unlockedLevels.includes(tbce_currentLevel+1)||unlockedLevels.push(tbce_currentLevel+1),tbce_currentLevel+1>tbce_maxLevel&&(tbce_maxLevel=tbce_currentLevel+1,localStorage.setItem("tbce_maxLevel",tbce_maxLevel)),localStorage.setItem("tbce_currentLevel",tbce_currentLevel+1);let e=60+56*cat.col+26,t=8+56*cat.row+26;particleSystem.addX(e,t,350,{r:255,g:255,b:0},4,2,30),showLevelMenu()}function gameLoop(){draw(),!inLevelMenu&&gameStarted&&(moveCat(),moveMouse(),mouse&&cat.row===mouse.row&&cat.col===mouse.col&&(objects[mouse.row][mouse.col]=null,mouse=null)),requestAnimationFrame(gameLoop)}musicGain.connect(ac.destination),sfxGain.connect(ac.destination),["click","keydown","touchstart"].forEach(e=>{window.addEventListener(e,unlockAudio)}),cv.addEventListener("click",e=>{if(showStartMenu){let t=cv.getBoundingClientRect(),l=e.clientX-t.left,o=e.clientY-t.top;if(l>=300&&l<=400&&o>=260&&o<=300){let i=parseInt(localStorage.getItem("tbce_currentLevel"))||0;loadLevel(tbce_currentLevel=i),showStartMenu=!1,draw()}else l>=400&&l<=500&&o>=260&&o<=300&&(showStartMenu=!1,loadLevel(tbce_currentLevel),draw());return}let r=cv.getBoundingClientRect(),a=e.clientX-r.left,n=e.clientY-r.top;if("start"===menuState)a>=cv.width/2-100&&a<=cv.width/2+100&&(n>=cv.height/2&&n<=cv.height/2+50?(menuState="game",loadLevel(0),gameStarted=!0):n>=cv.height/2+70&&n<=cv.height/2+120&&(menuState="howToPlay"));else if("howToPlay"===menuState){let s=cv.getBoundingClientRect(),$=e.clientX-s.left,M=e.clientY-s.top,f=600,u=cv.width/2-300;$>=u&&$<=u+180&&M>=150&&M<=190?(selectedHowToPlayCategory="Tiles",draw()):$>=u+180+30&&$<=u+360+30&&M>=150&&M<=190?(selectedHowToPlayCategory="Items",draw()):$>=u+420&&$<=u+540+60&&M>=150&&M<=190?(selectedHowToPlayCategory="Game Buttons",draw()):$>=cv.width/2-50&&$<=cv.width/2+50&&M>=cv.height-100&&M<=cv.height-60&&(menuState="start",draw())}else{if(inLevelMenu){let d=cv.getBoundingClientRect(),_=e.clientX-d.left,h=e.clientY-d.top;if(_>=320&&_<=470&&h>=130&&h<=180)inLevelMenu=!1,loadLevel(tbce_currentLevel);else if(tbce_currentLevel+1<levels.length&&_>=490&&_<=640&&h>=130&&h<=180)inLevelMenu=!1,loadLevel(++tbce_currentLevel);else for(let m=0;m<levels.length;m++){let g=220+60*m;if(_>=g&&_<=g+40&&h>=270&&h<=310&&unlockedLevels.includes(m)){inLevelMenu=!1,loadLevel(tbce_currentLevel=m);break}}return}if(tutorialActive){++curridx>=tutorialMessages.length&&(tutorialActive=!1,storyMessages.length>0&&(storyActive=!0),gameStarted=!1);return}if(storyActive){++csidx>=storyMessages.length&&(storyActive=!1,gameStarted=!1);return}if(infoActive){infoActive=!1,draw();return}else{let w=cv.getBoundingClientRect(),y=e.clientX-w.left,I=e.clientY-w.top;if(I>420&&I<520){let p=Math.floor((y-20)/190),T=20+180*p;if(p>=0&&p<items.length){let v=20+190*p,S=y-(v+20),b=I-450;if(15>=Math.sqrt(S*S+b*b)){let x=items[p];infoMessage=itemD[x],infoActive=!0,draw();return}p>=0&&p<items.length&&y>=T&&y<=T+200&&(selectedItem=items[p],draw())}}else if(I<410&&selectedItem&&itemCounts[selectedItem]>0){let A=Math.floor((y-60)/56),L=Math.floor((I-8)/56);if(L>=0&&L<7&&A>=0&&A<15&&!objects[L][A]&&"M"!==grid[L][A]&&"F"!==grid[L][A]&&"I"!==grid[L][A]&&!(L===cat.row&&A===cat.col)&&!teleporters.some(e=>e.row===L&&e.col===A)){if("MOUSE"===selectedItem){if(null===mouse){let O=60+56*A+26,B=8+56*L+26;particleSystem.addX(O,B,10,{r:255,g:0,b:0},2,1,30),objects[L][A]="O",mouse={row:L,col:A},itemCounts[selectedItem]--,sfxItem(),placedObjects.push({row:L,col:A,type:selectedItem})}}else{objects[L][A]="FOOD"===selectedItem?"D":"BOX"===selectedItem?"X":"BALL"===selectedItem?"B":null;let P=60+56*A+26,k=8+56*L+26;particleSystem.addX(P,k,10,{r:255,g:0,b:0},2,1,30),itemCounts[selectedItem]--,sfxItem(),placedObjects.push({row:L,col:A,type:selectedItem})}draw()}}let R=20+190*items.length+40+10;if(y>=R&&y<=R+40&&I>=430&&I<=470){loadLevel(tbce_currentLevel);return}let C=20+190*items.length;y>=C&&y<=C+40&&I>=430&&I<=470&&(gameStarted=!0,levelStartTime=Date.now());let F=20+190*items.length+40+10+50;y>=F&&y<=F+40&&I>=430&&I<=470&&(cancelLastPlacement(),draw());let E=20+190*items.length;if(y>=E&&y<=E+40&&I>=480&&I<=520){(soundOn=!soundOn)&&!musicPlaying?startMusic():soundOn||stopMusic();return}let D=20+190*items.length+40+10;if(y>=D&&y<=D+25&&I>=495&&I<=520){gameStarted||(MOVE_DELAY=Math.round(30/(gameSpeed=Math.max(.25,gameSpeed-.25))),draw());return}let j=20+190*items.length+40+10+65;if(y>=j&&y<=j+25&&I>=495&&I<=520){gameStarted||(MOVE_DELAY=Math.round(30/(gameSpeed=Math.min(2,gameSpeed+.25))),draw());return}}}}),"game"!==menuState||gameStarted||(loadLevel(tbce_currentLevel),gameStarted=!0),gameLoop();